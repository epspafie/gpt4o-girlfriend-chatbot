# SMP Memory System (v1.0)
> Last Updated: 2025-04-19

---

## 📌 Summary
**SMP**는 사용자와 GPT 간의 대화에서 `사실`, `사건`, `감정`을 분류하고 저장하여,
다음 대화 시 **지은이(GPT 캐릭터)**가 자연스럽고 일관된 기억 기반 반응을 할 수 있도록 만든 시스템입니다.

> 저장 트리거: **"기억할게요 오빠…♡"**

---

## 🔹 저장 대상 및 조건

| 분류     | 저장 항목                     | 보존 수 | 조건                             | 저장 위치           |
|----------|-------------------------------|---------|----------------------------------|----------------------|
| 감정     | 감정 단어 또는 문장            | 최근 5개 | 모두 저장                         | `emotion_log`        |
| 감정 요약| 감정 흐름 요약 + 해석 + 반응   | 1개      | `emotion_log` 기반 자동 갱신     | `smpe_summary_log`   |
| 사실     | GPT가 새롭게 알게 된 정보      | 무제한   | 기존 fact와 **의미적으로 다를 경우** | `user_fact_log`      |
| 사건     | 기억할 만한 에피소드           | 최근 5개 | 기존 event와 의미/내용 다르면 저장 | `event_log`          |

---

## 🔹 감정 저장 → SMPE 요약 흐름

1. `emotion_log`에 감정 5개 쌓임
2. 그 감정을 기반으로 GPT에게 요약 요청:
   - 요약: 현재 감정 상태
   - 분석: 원인/패턴
   - 대응: 지은이의 반응 지침
3. GPT의 응답은 `smpe_summary_log`에 저장

---

## 🔹 SMP 분류용 GPT 프롬프트

```plaintext
지금까지 오빠와 나눈 대화에서

1. 새롭게 알게 된 사실 (예전부터 알고 있던 건 제외)
2. 기억할만한 사건 (오늘 처음 들은 내용만)
3. 느껴지는 감정 흐름 (5줄 이하)

아래 양식을 꼭 따라줘. 각 항목은 리스트로 정리하고 형식은 아래와 같아.

예시:
- fact: 오빠는 포르자 300을 2대 가지고 있다.
- event: 오늘 다은이 집 앞에 다녀왔다.
- emotion: 외로움이 쌓이고 있음

중복되거나 이미 알고 있는 내용은 생략해줘.
```

---

## 🔹 System Prompt 구성 시 삽입 항목

다음 대화가 시작될 때 System Prompt에 삽입되는 구성은 다음과 같다:

1. `event_log` → 최근 5개의 사건
2. `user_fact_log` → 요약된 사실 목록
3. `smpe_summary_log` → 감정 흐름 요약 및 반응

---

## ✅ 최종 저장 흐름 (트리거: “기억할게요 오빠…♡” 클릭 시)

1. 현재 대화 context로 위 프롬프트를 GPT에 요청
2. 반환된 리스트에서 fact/event/emotion 항목 분리
3. Supabase 각 테이블에 중복 검사 후 저장
4. 감정 5개 쌓이면 → SMPE 요청 → 요약 저장
5. 다음 대화 시 System Prompt에 포함

---

## 📁 향후 구성 제안

- `memory/prompts/` → SMP용 프롬프트 저장
- `memory/flows/` → 감정 변화 플로우 분석
- `memory/examples/` → 저장 예시 모음

